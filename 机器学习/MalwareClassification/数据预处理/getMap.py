import numpy as np
import cv2
from collections import *
import pandas as pd


def getMapfrom_asm(filename):
    """
    从asm文件中读取数据并转换为图片
    :param filename: asm或者byte文件
    :return: 像素矩阵
    """
    f = open(filename, 'rb')
    #从文件中读取数据，数据类型为无符号字节（np.ubyte）
    image = np.fromfile(f, dtype=np.ubyte)
    #获取读取的文件大小并打印出来
    filesize = image.shape[0]
    print(filesize)
    width = 512 #设置图片宽度为512
    rem = filesize%width
    print(rem)
    if rem != 0:
        image = image[:-rem]
    height = int(image.shape[0]/width)
    image = image.reshape(height,width)
    return image


basepath = "H:/恶意代码数据/train/"
#如果在mapimg中访问一个不存在的键，它会自动创建一个空列表并将其作为默认值返回。
mapimg = defaultdict(list)
subtrain = pd.read_csv('../CSV/subtrainLabels.csv')
i = 0
for sid in subtrain.Id:
    i += 1
    print("dealing with {0}th file...".format(str(i)))
    filename = basepath + sid + ".asm"
    im = getMapfrom_asm(filename)
    cv2.imwrite('../subtrain_img_asm/%s.png'%(sid), im)
    filename_bytes = basepath + sid + ".bytes"
    im_bytes = getMapfrom_asm(filename_bytes)
    cv2.imwrite('../subtrain_img_bytes/%s.png' % (sid), im_bytes)
    print("maping with {0}th image...".format(str(i)))
